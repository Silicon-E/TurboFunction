# Turbo
### .mcfunction Preprocessor

Turbo speeds up your .mcfunction coding with constructs including constants, macros, code blocks, and local functions.

# Syntax

Turbo acts on source files. Each source file represents a function. Turbo source files are text files in the `data/` folder of a data pack that have filenames ending in "` SRC.mcfunction`" (note the separating space). These files are discarded by Minecraft when it loads the data pack. Each Turbo source file compiles to a .mcfunction file at the same location with the same name, sans the "` SRC`" suffix.

Turbo source files consist of lines separated by line endings. Each line is one of:
- Whitespace
- A comment
- A command
- A preprocessor directive

Whitespace and comments are transcluded into the output.
Some directives define **symbols**. Symbols are names containing *letters, underscores, and numbers*. Symbols can generate code by way of **embeds**.
Commands contain **code**. Code is transcluded into the output, with any embeds replaced with the text those embeds evaluate to. Top-level embeds in a command must evaluate to text.

### Embeds

All embeds begin with a `%(` and end with a closing `)`. Embeds evaluate to some value. Each embed is either an **insertion** or an **invocation**. Insertions have the form:
`%( symbol )`. Invocations have the form: `%( symbol : arg , arg , ... )`. `symbol` is code that must evaluate to a defined symbol. `arg` is code that may evaluate to any value. Surrounding whitespace is stripped from both, unless the code is wrapped with ` `` ` backticks. Code within embeds may contain other embeds.

### Code Blocks

Some directives mark the beginning of code blocks. A code block is one of these directives, followed by any number of lines, followed by an `##end` directive. Code blocks can contain other code blocks. Lines inside a code block are used by the opening directive and are not transcluded into the containing scope.

### Escape Characters

Protected tokens can be escaped with a leading `\`. A `\` not followed by a protected token is transcluded into the output. Protected tokens are:
- `%(`
- `)`, if inside an embed.
- Newline, if outside an embed.
- `:`, if inside an embed's symbol section.
- `,`, if inside an embed's arg section.
- `\`, if followed by a non-`\` protected token.

## Directives

### ##end
Marks the end of a code block.

### ##define

Defines one of two types of symbol: a **variable** or a **template**.

`##define` directives have two forms:
> ```
> ##define <name>[( <arg1 name> , <arg2 name> , ... )] <body>
> 
> ##define <name>[( <arg name> , ... )]
>     <body>
>     ...
> ##end
> ```
> `name` - A valid symbol name.
> 
> `body` - Code. If defining a variable, the body is evaluated immediately. If defining a template, the template's argument symbols are in scope throughout the body.
> 
> In single-line form, surrounding whitespace is stripped unless the code is wrapped with ` `` ` backticks.

If no argument list is given, defines a variable. When inserted, a variable evaluates to the value that its body evaluated to. Variables cannot be invoked.

If an argument list is given, defines a template. When inserted, a template evaluates to a reference to itself. When invoked, a template evaluates to the value that its body evaluates to, considering the values of the argument symbols supplied to the invocation.

#### Examples
Basics:
```
##define offset ~0 ~15.1 ~2
##define handle_entity(entity_id, particle)
    execute at @e[type=%( entity_id )] run particle %( particle ) OFFSET
##end
%( handle_entity : creeper, block lime_wool )
%( handle_entity : player,  instant_effect )
```
Passing template references:
```
##define invoke_twice(template, arg)
    %( template : %( arg ) )
    %( template : %( arg ) )
##end
##define foo(bar) say %( bar )
%( invoke_twice : $( foo ), Hello World! )
```
Indirect variable insertion:
```
##define coal__value 60
##define iron__value 100
##define sell(mineral)
    scoreboard players add @s money $( $( mineral )__value )
##end
```

### ##block

Generates an `execute` command that conditionally executes a block of code.

> ```
> ##block
> <execute template>
>   <body>
>   ...
> ##end
> ```
> `execute template` - An `execute` command missing the `run` subcommand
> 
> `body` - Zero or more lines

#### Example
```
##block
execute if block ~ ~ ~ gold_ore
    # Emit breaking FX on the top block.
    particle block gold_ore ~0.5 ~0.5 ~0.5 0.25 0.25 0.25 1 10
    playsound block.stone.break block @a ~0.5 ~0.5 ~0.5 0.5
##end
```
Output:
```
execute if block ~ ~ ~ gold_ore run function mydatapack:path_to_source/__turbo/sourcename_arbitrarysuffix
```

### ##function

Defines a type of symbol called a **local function**. When inserted, a local function evaluates to the namespaced ID of a function generated by Turbo containing the code supplied to the `##function` directive. Local functions cannot be invoked.

> ```
> ##function <name>
>   <body>
>   ...
> ##end
> ```
> `name` - A valid symbol name
> 
> `body` - Zero or more lines

#### Example

```
##function loop
    scoreboard players remove #reach num 1
    execute if score #reach num matches 1.. run function %( loop )
##end
scoreboard players set #reach num 5
function %( loop )
```

### ##include

Defines all the symbols that are defined in the top-level scope of another source file.

> ```
> ##include <source>
> ```
> `source` - The namespaced ID of the source file to include symbols from

#### Example

```
##include turbopreprocess:num
%( op : #foo num = @s num )
```